<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ZodiacLab â€” Smart Formula Calculator</title>
<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b; --card:#071028;
    --accent:#4CAF50; --muted:#9aa6b2; --light:#f8fafc;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--light);}
  .wrap{max-width:1100px;margin:22px auto;padding:18px;box-sizing:border-box;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
  header h1{font-size:1.3rem;margin:0}
  .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;box-shadow:0 6px 28px rgba(2,6,23,0.7);}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  .controls select, .controls button { padding:10px;border-radius:8px;border:none;font-size:1rem;box-sizing:border-box }
  select { min-width:240px; background:#fff; color:#222; }
  .btn { background:var(--accent); color:#022; padding:10px 14px; font-weight:700; border-radius:8px; cursor:pointer; }
  .btn.ghost{background:transparent;color:var(--light);border:1px solid rgba(255,255,255,0.06)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:12px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} select{min-width:unset;width:100%} }
  .inputs{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px}
  .field{display:flex;gap:8px;align-items:center;margin:8px 0}
  .field label{min-width:140px;color:var(--muted);font-size:0.95rem}
  .field input[type="number"], .field input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
  .formula{margin-top:10px;color:var(--muted);font-style:italic}
  .result{margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
  .help{color:var(--muted);font-size:0.92rem;margin-top:8px}
  .cat-list{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid transparent;color:var(--light)}
  .chip.active{background:var(--accent);color:#022; font-weight:700}
  .sidebar { background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; }
  small.note{display:block;color:var(--muted);margin-top:8px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
  .result .val { color: var(--accent); font-size:1.15rem; margin-left:6px; }
  .formulaUnit { color:var(--muted); font-size:0.95rem; margin-top:6px; }
  input[type="number"] { width:160px; }
  .row { display:flex; flex-wrap:wrap; gap:10px; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:1.9rem">ðŸ§®</div>
      <div>
        <h1>ZodiacLab â€” Smart Formula Calculator</h1>
        <div style="color:var(--muted);font-size:0.95rem">Categories, dynamic inputs, formula preview and result (3 decimal places)</div>
      </div>
    </header>

    <div class="card">
      <div class="cat-list" id="catList"></div>

      <div class="controls">
        <select id="categorySelect"><option value="">-- Category --</option></select>
        <select id="formulaSelect"><option value="">-- Formula --</option></select>
        <button class="btn" id="inputBtn">Input</button>
        <button class="btn ghost" id="clearBtn">Reset</button>
      </div>

      <div class="grid">
        <div>
          <div id="inputArea" class="inputs">
            <div id="inputsPlaceholder">Select category â†’ formula â†’ click <b>Input</b></div>
          </div>

          <div id="formulaText" class="formula"></div>
          <div id="unitText" class="formulaUnit"></div>
          <div id="resultBox" class="result" style="display:none"></div>
          <div id="helpText" class="help"></div>
        </div>

        <aside class="sidebar">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:700">Preview & Notes</div>
            <div style="color:var(--muted);font-size:0.9rem" id="lastCalc">No calc yet</div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700;margin-bottom:10px">Formula preview</div>
            <div id="preview" style="color:var(--muted);line-height:1.4"></div>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:700;margin-bottom:8px">Tips</div>
            <small class="note">Ensure units are consistent. Results show 3 decimal places where applicable.</small>
          </div>
        </aside>
      </div>
    </div>

    <footer>Extend by adding more formulas to the `FORMULAS` array in script.</footer>
  </div>

<script>
/* ---------- Data-driven formulas (approx 50) ---------- */
/* Each entry: {cat, name, inputs:[{k,label}], formula, unit(optional), calc: function(vals){}, help(optional)} */
const FORMULAS = [
  /* Geometry 2D */
  {cat:'Geometry', name:'Area - Triangle (base,height)', inputs:[{k:'b',label:'Base b'},{k:'h',label:'Height h'}],
    formula:'(1/2) Ã— b Ã— h', unit:'lengthÂ² (e.g., mÂ²)', calc:v=>0.5*v.b*v.h},
  {cat:'Geometry', name:'Area - Right Triangle (legs a,b)', inputs:[{k:'a',label:'Leg a'},{k:'b',label:'Leg b'}],
    formula:'(1/2) Ã— a Ã— b', unit:'lengthÂ²', calc:v=>0.5*v.a*v.b},
  {cat:'Geometry', name:'Area - Equilateral Triangle (side a)', inputs:[{k:'a',label:'Side a'}],
    formula:'(âˆš3/4) Ã— aÂ²', unit:'lengthÂ²', calc:v=>(Math.sqrt(3)/4)*v.a*v.a},
  {cat:'Geometry', name:'Area - Heron (sides a,b,c)', inputs:[{k:'a',label:'Side a'},{k:'b',label:'Side b'},{k:'c',label:'Side c'}],
    formula:'s=(a+b+c)/2; area=âˆš(s(s-a)(s-b)(s-c))', unit:'lengthÂ²', calc:v=>{
      const s=(v.a+v.b+v.c)/2; const t=s*(s-v.a)*(s-v.b)*(s-v.c); return t<=0? NaN:Math.sqrt(t);
    }},
  {cat:'Geometry', name:'Area - Rectangle (l,w)', inputs:[{k:'l',label:'Length l'},{k:'w',label:'Width w'}],
    formula:'l Ã— w', unit:'lengthÂ²', calc:v=>v.l*v.w},
  {cat:'Geometry', name:'Area - Square (a)', inputs:[{k:'a',label:'Side a'}],
    formula:'aÂ²', unit:'lengthÂ²', calc:v=>v.a*v.a},
  {cat:'Geometry', name:'Area - Parallelogram (base,height)', inputs:[{k:'b',label:'Base b'},{k:'h',label:'Height h'}],
    formula:'b Ã— h', unit:'lengthÂ²', calc:v=>v.b*v.h},
  {cat:'Geometry', name:'Area - Trapezoid (a,b,h)', inputs:[{k:'a',label:'Base a'},{k:'b',label:'Base b'},{k:'h',label:'Height h'}],
    formula:'((a+b)/2) Ã— h', unit:'lengthÂ²', calc:v=>0.5*(v.a+v.b)*v.h},
  {cat:'Geometry', name:'Area - Circle (r)', inputs:[{k:'r',label:'Radius r'}],
    formula:'Ï€ Ã— rÂ²', unit:'lengthÂ²', calc:v=>Math.PI*v.r*v.r},
  {cat:'Geometry', name:'Circumference - Circle (r)', inputs:[{k:'r',label:'Radius r'}],
    formula:'2 Ã— Ï€ Ã— r', unit:'length', calc:v=>2*Math.PI*v.r},
  {cat:'Geometry', name:'Area - Ellipse (a,b)', inputs:[{k:'a',label:'Semi-major a'},{k:'b',label:'Semi-minor b'}],
    formula:'Ï€ Ã— a Ã— b', unit:'lengthÂ²', calc:v=>Math.PI*v.a*v.b},
  {cat:'Geometry', name:'Sector Area (r,Î¸ deg)', inputs:[{k:'r',label:'Radius r'},{k:'theta',label:'Angle Î¸ (deg)'}],
    formula:'(Î¸/360) Ã— Ï€ Ã— rÂ²', unit:'lengthÂ²', calc:v=>(v.theta/360)*Math.PI*v.r*v.r},
  {cat:'Geometry', name:'Perimeter - Rectangle (l,w)', inputs:[{k:'l',label:'Length l'},{k:'w',label:'Width w'}],
    formula:'2 Ã— (l + w)', unit:'length', calc:v=>2*(v.l+v.w)},
  {cat:'Geometry', name:'Perimeter - Square (a)', inputs:[{k:'a',label:'Side a'}],
    formula:'4 Ã— a', unit:'length', calc:v=>4*v.a},
  {cat:'Geometry', name:'Regular Polygon Area (n,a)', inputs:[{k:'n',label:'# sides n'},{k:'a',label:'Side a'}],
    formula:'(n aÂ²)/(4 tan(Ï€/n))', unit:'lengthÂ²', calc:v=> (v.n*v.a*v.a)/(4*Math.tan(Math.PI/v.n)) },

  /* 3D Volumes & Surface */
  {cat:'3D', name:'Volume - Sphere (r)', inputs:[{k:'r',label:'Radius r'}],
    formula:'(4/3) Ã— Ï€ Ã— rÂ³', unit:'lengthÂ³', calc:v=> (4/3)*Math.PI*Math.pow(v.r,3)},
  {cat:'3D', name:'Surface Area - Sphere (r)', inputs:[{k:'r',label:'Radius r'}],
    formula:'4 Ã— Ï€ Ã— rÂ²', unit:'lengthÂ²', calc:v=>4*Math.PI*v.r*v.r},
  {cat:'3D', name:'Volume - Cylinder (r,h)', inputs:[{k:'r',label:'Radius r'},{k:'h',label:'Height h'}],
    formula:'Ï€ Ã— rÂ² Ã— h', unit:'lengthÂ³', calc:v=>Math.PI*v.r*v.r*v.h},
  {cat:'3D', name:'Surface Area - Cylinder (total)', inputs:[{k:'r',label:'Radius r'},{k:'h',label:'Height h'}],
    formula:'2Ï€r(h + r)', unit:'lengthÂ²', calc:v=>2*Math.PI*v.r*(v.h+v.r)},
  {cat:'3D', name:'Volume - Cone (r,h)', inputs:[{k:'r',label:'Radius r'},{k:'h',label:'Height h'}],
    formula:'(1/3) Ï€ rÂ² h', unit:'lengthÂ³', calc:v=> (1/3)*Math.PI*v.r*v.r*v.h},
  {cat:'3D', name:'Volume - Hemisphere (r)', inputs:[{k:'r',label:'Radius r'}],
    formula:'(2/3) Ï€ rÂ³', unit:'lengthÂ³', calc:v=> (2/3)*Math.PI*Math.pow(v.r,3)},
  {cat:'3D', name:'Volume - Rectangular Prism (l,w,h)', inputs:[{k:'l',label:'Length l'},{k:'w',label:'Width w'},{k:'h',label:'Height h'}],
    formula:'l Ã— w Ã— h', unit:'lengthÂ³', calc:v=>v.l*v.w*v.h},
  {cat:'3D', name:'Surface Area - Cube (a)', inputs:[{k:'a',label:'Side a'}],
    formula:'6 Ã— aÂ²', unit:'lengthÂ²', calc:v=>6*v.a*v.a},
  {cat:'3D', name:'Volume - Cube (a)', inputs:[{k:'a',label:'Side a'}],
    formula:'aÂ³', unit:'lengthÂ³', calc:v=>Math.pow(v.a,3)},
  {cat:'3D', name:'Volume - Pyramid (Base area B, h)', inputs:[{k:'B',label:'Base area B'},{k:'h',label:'Height h'}],
    formula:'(1/3) Ã— B Ã— h', unit:'lengthÂ³', calc:v=> (1/3)*v.B*v.h},

  /* Algebra & Series */
  {cat:'Algebra', name:'Quadratic Roots (a,b,c)', inputs:[{k:'a',label:'a'},{k:'b',label:'b'},{k:'c',label:'c'}],
    formula:'[-b Â± âˆš(bÂ²-4ac)]/(2a)', calc:v=>{
      const D=v.b*v.b - 4*v.a*v.c;
      if (D<0) return {error:'Complex roots', D: Number(D.toFixed(6))};
      const r1 = (-v.b+Math.sqrt(D))/(2*v.a); const r2 = (-v.b-Math.sqrt(D))/(2*v.a);
      return {r1,r2,D:Number(D.toFixed(6))};
    }, help:'If discriminant < 0, roots are complex.'},
  {cat:'Algebra', name:'Sum of first n natural numbers (n)', inputs:[{k:'n',label:'n'}],
    formula:'n(n+1)/2', calc:v=> (v.n*(v.n+1))/2},
  {cat:'Algebra', name:'Sum of squares 1Â²+..+nÂ²', inputs:[{k:'n',label:'n'}],
    formula:'n(n+1)(2n+1)/6', calc:v=> (v.n*(v.n+1)*(2*v.n+1))/6},
  {cat:'Algebra', name:'Sum of cubes 1Â³+..+nÂ³', inputs:[{k:'n',label:'n'}],
    formula:'[n(n+1)/2]Â²', calc:v=> Math.pow((v.n*(v.n+1)/2),2)},
  {cat:'Algebra', name:'Arithmetic Mean (comma values)', inputs:[{k:'vals',label:'Comma-separated numbers'}],
    formula:'mean = sum / n', calc:v=>{
      const arr=(''+v.vals).split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n)); if (!arr.length) return NaN;
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }, help:'Enter comma-separated values, e.g. 2, 3.5, 10' },
  {cat:'Algebra', name:'Geometric Series (finite) S_n', inputs:[{k:'a',label:'First term a'},{k:'r',label:'Ratio r'},{k:'n',label:'n'}],
    formula:'S_n = a(1-r^n)/(1-r)', calc:v=> v.r===1? v.a*v.n : v.a*(1-Math.pow(v.r,v.n))/(1-v.r) },
  {cat:'Algebra', name:'Geometric Series (infinite)', inputs:[{k:'a',label:'First term a'},{k:'r',label:'Ratio r'}],
    formula:'S = a/(1-r) for |r|<1', calc:v=> Math.abs(v.r)<1? v.a/(1-v.r):NaN},

  /* Trigonometry */
  {cat:'Trig', name:'Pythagoras (hypotenuse c)', inputs:[{k:'a',label:'Side a'},{k:'b',label:'Side b'}],
    formula:'c = âˆš(aÂ² + bÂ²)', calc:v=>Math.sqrt(v.a*v.a + v.b*v.b)},
  {cat:'Trig', name:'Sine Rule (find side b)', inputs:[{k:'a',label:'Side a'},{k:'A',label:'Angle A (deg)'},{k:'B',label:'Angle B (deg)'}],
    formula:'a/sinA = b/sinB', calc:v=> (v.a / Math.sin(v.A*Math.PI/180)) * Math.sin(v.B*Math.PI/180)},
  {cat:'Trig', name:'Cosine Rule (find side c)', inputs:[{k:'a',label:'Side a'},{k:'b',label:'Side b'},{k:'C',label:'Angle C (deg)'}],
    formula:'cÂ² = aÂ² + bÂ² - 2ab cos C', calc:v => Math.sqrt(v.a*v.a + v.b*v.b - 2*v.a*v.b*Math.cos(v.C*Math.PI/180))},
  {cat:'Trig', name:'Area - triangle (1/2 ab sin C)', inputs:[{k:'a',label:'Side a'},{k:'b',label:'Side b'},{k:'C',label:'Included angle C (deg)'}],
    formula:'(1/2)ab sin C', calc:v => 0.5*v.a*v.b*Math.sin(v.C*Math.PI/180) },
  {cat:'Trig', name:'Degrees â†’ Radians', inputs:[{k:'deg',label:'Degrees'}], formula:'rad = deg Ã— Ï€/180', calc:v=> v.deg*Math.PI/180},
  {cat:'Trig', name:'Radians â†’ Degrees', inputs:[{k:'rad',label:'Radians'}], formula:'deg = rad Ã— 180/Ï€', calc:v=> v.rad*180/Math.PI},

  /* Physics */
  {cat:'Physics', name:'Speed (v = d / t)', inputs:[{k:'d',label:'Distance d'},{k:'t',label:'Time t'}],
    formula:'v = d / t', unit:'distance/time (e.g., m/s)', calc:v=> v.d / v.t},
  {cat:'Physics', name:'Acceleration (a = (v - u)/t)', inputs:[{k:'u',label:'Initial u'},{k:'v',label:'Final v'},{k:'t',label:'Time t'}],
    formula:'a = (v - u) / t', unit:'m/sÂ²', calc:v=> (v.v - v.u) / v.t},
  {cat:'Physics', name:'Force (F = m Ã— a)', inputs:[{k:'m',label:'Mass m (kg)'},{k:'a',label:'Acceleration a (m/sÂ²)'}],
    formula:'F = m Ã— a', unit:'N (kgÂ·m/sÂ²)', calc:v=> v.m * v.a},
  {cat:'Physics', name:'Kinetic Energy (Â½mvÂ²)', inputs:[{k:'m',label:'Mass m (kg)'},{k:'v',label:'Velocity v (m/s)'}],
    formula:'KE = 1/2 m vÂ²', unit:'J (kgÂ·mÂ²/sÂ²)', calc:v=> 0.5 * v.m * v.v * v.v},
  {cat:'Physics', name:'Potential Energy (mgh)', inputs:[{k:'m',label:'Mass m (kg)'},{k:'g',label:'g (9.8 m/sÂ²)'},{k:'h',label:'Height h (m)'}],
    formula:'PE = m Ã— g Ã— h', unit:'J', calc:v=> v.m * v.g * v.h},
  {cat:'Physics', name:'Work (W = F Ã— d)', inputs:[{k:'F',label:'Force F (N)'},{k:'d',label:'Distance d (m)'}],
    formula:'W = F Ã— d', unit:'J', calc:v=> v.F * v.d},
  {cat:'Physics', name:'Power (P = W / t)', inputs:[{k:'W',label:'Work W (J)'},{k:'t',label:'Time t (s)'}],
    formula:'P = W / t', unit:'W', calc:v=> v.W / v.t},
  {cat:'Physics', name:'Pressure (P = F / A)', inputs:[{k:'F',label:'Force F (N)'},{k:'A',label:'Area A (mÂ²)'}],
    formula:'P = F / A', unit:'Pa (N/mÂ²)', calc:v=> v.F / v.A},
  {cat:'Physics', name:'Density (Ï = m / V)', inputs:[{k:'m',label:'Mass m (kg)'},{k:'V',label:'Volume V (mÂ³)'}],
    formula:'Ï = m / V', unit:'kg/mÂ³', calc:v=> v.m / v.V},
  {cat:'Physics', name:'Ohm\'s Law (V = I Ã— R)', inputs:[{k:'I',label:'Current I (A)'},{k:'R',label:'Resistance R (Î©)'}],
    formula:'V = I Ã— R', unit:'V', calc:v=> v.I * v.R},
  {cat:'Physics', name:'Electrical Power (P = V Ã— I)', inputs:[{k:'V',label:'Voltage V (V)'},{k:'I',label:'Current I (A)'}],
    formula:'P = V Ã— I', unit:'W', calc:v=> v.V * v.I},

  /* Statistics */
  {cat:'Statistics', name:'Mean (comma values)', inputs:[{k:'vals',label:'Comma-separated numbers'}],
    formula:'mean = sum(values)/n', calc:v=>{
      const arr=(''+v.vals).split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n));
      if (!arr.length) return NaN; return arr.reduce((a,b)=>a+b,0)/arr.length;
    }, help:'Enter values separated by commas, e.g., 2,3.5,10' },
  {cat:'Statistics', name:'Median (comma values)', inputs:[{k:'vals',label:'Comma-separated numbers'}],
    formula:'sort values and pick middle', calc:v=>{
      const arr=(''+v.vals).split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
      if (!arr.length) return NaN; const m=Math.floor(arr.length/2); return arr.length%2? arr[m] : (arr[m-1]+arr[m])/2;
    }},
  {cat:'Statistics', name:'Population Variance (comma values)', inputs:[{k:'vals',label:'Comma-separated numbers'}],
    formula:'ÏƒÂ² = Î£(x-Î¼)Â² / N', calc:v=>{
      const arr=(''+v.vals).split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n));
      if (!arr.length) return NaN; const mean=arr.reduce((a,b)=>a+b,0)/arr.length;
      return arr.reduce((s,x)=>s+(x-mean)*(x-mean),0)/arr.length;
    }},
  {cat:'Statistics', name:'Population Standard Deviation', inputs:[{k:'vals',label:'Comma-separated numbers'}],
    formula:'Ïƒ = sqrt(ÏƒÂ²)', calc:v=>{
      const arr=(''+v.vals).split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n));
      if (!arr.length) return NaN; const mean=arr.reduce((a,b)=>a+b,0)/arr.length;
      const vs=arr.reduce((s,x)=>s+(x-mean)*(x-mean),0)/arr.length; return Math.sqrt(vs);
    }},

  /* Math extras */
  {cat:'Math', name:'Factorial (n!)', inputs:[{k:'n',label:'n (integer â‰¥ 0)'}],
    formula:'n!', calc:v=>{ const n=Math.floor(v.n); if (n<0) return NaN; let f=1; for(let i=2;i<=n;i++) f*=i; return f; }},
  {cat:'Math', name:'nCr Combination (n,r)', inputs:[{k:'n',label:'n'},{k:'r',label:'r'}],
    formula:'n!/(r!(n-r)!)', calc:v=>{ const n=Math.floor(v.n), r=Math.floor(v.r); if (r<0||r>n) return NaN; function fact(x){let f=1;for(let i=2;i<=x;i++) f*=i; return f;} return fact(n)/(fact(r)*fact(n-r)); }},
  {cat:'Math', name:'Log base b', inputs:[{k:'x',label:'x (positive)'},{k:'b',label:'base b (positive)'}],
    formula:'log_b(x) = ln(x)/ln(b)', calc:v=> Math.log(v.x)/Math.log(v.b) },
  {cat:'Math', name:'Exponential e^x', inputs:[{k:'x',label:'x'}], formula:'e^x', calc:v=> Math.exp(v.x) },
  {cat:'Math', name:'Permutation nPr', inputs:[{k:'n',label:'n'},{k:'r',label:'r'}],
    formula:'n!/(n-r)!', calc:v=>{ const n=Math.floor(v.n), r=Math.floor(v.r); if (r<0||r>n) return NaN; function fact(x){let f=1;for(let i=2;i<=x;i++) f*=i; return f;} return fact(n)/fact(n-r); }},

  /* Series / Sequences */
  {cat:'Series', name:'AP nth term (a + (n-1)d)', inputs:[{k:'a',label:'First term a'},{k:'d',label:'Difference d'},{k:'n',label:'n'}],
    formula:'a_n = a + (n-1)d', calc:v=> v.a + (v.n-1)*v.d},
  {cat:'Series', name:'Sum AP (n/2)(a + l)', inputs:[{k:'a',label:'First a'},{k:'l',label:'Last l'},{k:'n',label:'n'}],
    formula:'S_n = n/2 Ã— (a + l)', calc:v=> (v.n/2)*(v.a+v.l)},
  {cat:'Series', name:'Sum GP (finite) S_n', inputs:[{k:'a',label:'First a'},{k:'r',label:'Ratio r'},{k:'n',label:'n'}],
    formula:'S_n = a(1-r^n)/(1-r)', calc:v=> v.r===1? v.a*v.n : v.a*(1-Math.pow(v.r,v.n))/(1-v.r)},
];

/* ---------- Build UI & logic ---------- */
const categories = [...new Set(FORMULAS.map(f=>f.cat))];

const catList = document.getElementById('catList');
const categorySelect = document.getElementById('categorySelect');
const formulaSelect = document.getElementById('formulaSelect');
const inputBtn = document.getElementById('inputBtn');
const inputArea = document.getElementById('inputArea');
const formulaText = document.getElementById('formulaText');
const unitText = document.getElementById('unitText');
const preview = document.getElementById('preview');
const helpText = document.getElementById('helpText');
const resultBox = document.getElementById('resultBox');
const lastCalc = document.getElementById('lastCalc');
const clearBtn = document.getElementById('clearBtn');

function buildCategoryChips(){
  catList.innerHTML = '';
  categories.forEach(cat=>{
    const d = document.createElement('div'); d.className='chip'; d.textContent = cat;
    d.onclick = ()=> { selectCategory(cat, d); categorySelect.value = cat; populateFormulas(cat); };
    catList.appendChild(d);
  });
}
function populateCategorySelect(){
  categorySelect.innerHTML = '<option value="">-- Category --</option>';
  categories.forEach(c=> { const opt = document.createElement('option'); opt.value=c; opt.textContent=c; categorySelect.appendChild(opt); });
}
function populateFormulas(cat){
  formulaSelect.innerHTML = '<option value="">-- Formula --</option>';
  FORMULAS.filter(f=>f.cat===cat).forEach((f,idx)=>{
    const opt = document.createElement('option');
    opt.value = FORMULAS.indexOf(f);
    opt.textContent = f.name;
    formulaSelect.appendChild(opt);
  });
  preview.textContent = '';
  formulaText.textContent = '';
  unitText.textContent = '';
  resultBox.style.display = 'none';
  helpText.textContent = '';
}

/* initial populate */
buildCategoryChips(); populateCategorySelect();
categorySelect.addEventListener('change', e=> {
  if (e.target.value) { populateFormulas(e.target.value); highlightChip(e.target.value); }
});
function highlightChip(cat){
  [...catList.children].forEach(c=> c.classList.toggle('active', c.textContent===cat));
}

/* select default first category */
if (categories.length) {
  const first = categories[0];
  highlightChip(first);
  populateFormulas(first);
  categorySelect.value = first;
}

/* show input fields */
inputBtn.addEventListener('click', showInputs);
function showInputs(){
  const idx = formulaSelect.value;
  if (!idx) { inputArea.innerHTML = '<div id="inputsPlaceholder">Please choose a formula.</div>'; return; }
  const F = FORMULAS[idx];
  preview.textContent = F.formula || '';
  formulaText.textContent = F.name;
  unitText.textContent = F.unit? `Unit: ${F.unit}` : '';
  helpText.textContent = F.help || '';
  // build inputs
  const container = document.createElement('div'); container.className='row';
  F.inputs.forEach(inp=>{
    const fld = document.createElement('div'); fld.className='field';
    const label = document.createElement('label'); label.textContent = inp.label || inp.k;
    const input = document.createElement('input');
    input.id = 'in_'+inp.k;
    if (inp.k === 'vals') { input.type='text'; input.placeholder = 'e.g. 2,3.5,10'; input.style.minWidth='220px'; }
    else { input.type='number'; input.step='any'; input.placeholder = inp.label || inp.k; input.style.width='160px'; }
    fld.appendChild(label); fld.appendChild(input); container.appendChild(fld);
  });
  const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Calculate';
  btn.onclick = ()=> calculate(idx);
  const btnWrap = document.createElement('div'); btnWrap.style.marginTop='8px'; btnWrap.appendChild(btn);
  inputArea.innerHTML = ''; inputArea.appendChild(container); inputArea.appendChild(btnWrap);
  resultBox.style.display = 'none';
}

/* reset */
clearBtn.addEventListener('click', ()=> {
  inputArea.innerHTML = '<div id="inputsPlaceholder">Select a formula and click <b>Input</b> to enter values.</div>';
  formulaText.textContent=''; preview.textContent=''; unitText.textContent=''; resultBox.style.display='none'; helpText.textContent='';
});

/* read inputs */
function readInputs(F){
  const vals = {};
  for (const inp of F.inputs){
    const el = document.getElementById('in_'+inp.k);
    if (!el) continue;
    if (inp.k === 'vals') vals[inp.k] = el.value;
    else vals[inp.k] = el.value === '' ? NaN : Number(el.value);
  }
  return vals;
}

/* format number to 3 decimal places if not integer */
function formatNumberOut(x){
  if (typeof x === 'number' && isFinite(x)){
    if (Math.abs(Math.round(x)-x) < 1e-9) return Math.round(x).toString();
    return Number(x.toFixed(3)).toString();
  }
  return x;
}

/* calculate */
function calculate(idx){
  const F = FORMULAS[idx];
  const vals = readInputs(F);
  // validate
  for (const inp of F.inputs){
    if (inp.k === 'vals') continue;
    const v = vals[inp.k];
    if (v === undefined || v === null || Number.isNaN(v)){
      resultBox.style.display='block';
      resultBox.innerHTML = `<span style="color:#ffb4b4">Please provide numeric value for "${inp.label}"</span>`;
      return;
    }
  }
  try {
    const out = F.calc(vals);
    resultBox.style.display='block';
    if (typeof out === 'object' && out !== null && !Array.isArray(out)){
      if (out.error){
        resultBox.innerHTML = `<div>Result: <span style="color:#ffd6a5">${out.error}</span></div>`;
      } else {
        let html = '<div>Result:</div><ul style="margin-left:18px">';
        for (const k of Object.keys(out)){
          html += `<li><b>${k}:</b> <span class="val">${formatNumberOut(out[k])}</span></li>`;
        }
        html += '</ul>';
        resultBox.innerHTML = html;
      }
    } else {
      resultBox.innerHTML = `Result: <span class="val">${formatNumberOut(out)}</span> ${F.unit? '<span style="margin-left:8px;color:var(--muted)">'+F.unit+'</span>':''}`;
    }
    lastCalc.textContent = new Date().toLocaleString();
  } catch (err){
    resultBox.style.display='block';
    resultBox.innerHTML = `<span style="color:#ffb4b4">Error: ${err.message}</span>`;
  }
}

/* allow selecting a formula directly from complete list - populate list */
(function populateAll(){
  const sel = document.getElementById('formulaSelect');
  // keep current options order by category then name
  sel.innerHTML = '<option value="">-- Formula --</option>';
  FORMULAS.forEach((f,i)=> {
    const opt = document.createElement('option'); opt.value = i; opt.textContent = `${f.cat} â€” ${f.name}`;
    sel.appendChild(opt);
  });
})();
</script>


<!-- Scientific Calculator Button (if not present already) -->
<div style="text-align:center; margin-top:20px;">
  <button id="openSciCalc" style="padding:12px 22px; font-size:1rem; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer;">
    ðŸ”¢ Scientific Calculator
  </button>
</div>

<!-- ======= Scientific Calculator Modal ======= -->
<div id="sciCalcModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
  <div id="sciBox" style="width:92%;max-width:480px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.35);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0;color:#222">Scientific Calculator</h3>
      <button id="closeSciCalc" style="background:#666;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer">Close</button>
    </div>

    <input id="sciDisplay" style="width:95%;font-size:1.25rem;text-align:right;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:12px">

    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
      <!-- Function row -->
      <button class="sc-btn sc-fn" data-t="sin(">sin</button>
      <button class="sc-btn sc-fn" data-t="cos(">cos</button>
      <button class="sc-btn sc-fn" data-t="tan(">tan</button>
      <button class="sc-btn sc-fn" data-t="asin(">asin</button>
      <button class="sc-btn sc-fn" data-t="acos(">acos</button>

      <button class="sc-btn sc-fn" data-t="atan(">atan</button>
      <button class="sc-btn sc-fn" data-t="sqrt(">âˆš</button>
      <button class="sc-btn sc-fn" data-t="log(">log</button>
      <button class="sc-btn sc-fn" data-t="ln(">ln</button>
      <button class="sc-btn sc-fn" data-t="exp(">eË£</button>

      <!-- Numbers -->
      <button class="sc-btn sc-num">7</button>
      <button class="sc-btn sc-num">8</button>
      <button class="sc-btn sc-num">9</button>
      <button class="sc-btn sc-op">/</button>
      <button class="sc-btn sc-tok" data-t="("> ( </button>

      <button class="sc-btn sc-num">4</button>
      <button class="sc-btn sc-num">5</button>
      <button class="sc-btn sc-num">6</button>
      <button class="sc-btn sc-op">*</button>
      <button class="sc-btn sc-tok" data-t=")"> ) </button>

      <button class="sc-btn sc-num">1</button>
      <button class="sc-btn sc-num">2</button>
      <button class="sc-btn sc-num">3</button>
      <button class="sc-btn sc-op">-</button>
      <button class="sc-btn sc-tok" data-t="**"> ^ </button>

      <button class="sc-btn sc-num">0</button>
      <button class="sc-btn sc-num">.</button>
      <button class="sc-btn sc-fn" data-t="fact(">fact</button>
      <button class="sc-btn sc-op">+</button>
      <button id="sciEqual" class="sc-btn" style="background:#ffb74d">=</button>

      <!-- Constants and controls -->
      <button id="sciPI" class="sc-btn sc-const">PI</button>
      <button id="sciE" class="sc-btn sc-const">E</button>
      <button id="sciAbs" class="sc-btn sc-fn" data-t="abs(">abs</button>
      <button id="sciClear" class="sc-btn" style="background:#f44336;color:#fff">CE</button>
      <button id="sciDel" class="sc-btn" style="background:#d32f2f;color:#fff">Del</button>

      <button id="sciBack" class="sc-btn" style="background:#ef6c00;color:#fff">Back</button>
      <button id="sciSpace" class="sc-btn" style="visibility:hidden"> </button>
    </div>

    <div style="font-size:0.85rem;color:#444;margin-top:10px">
      Notes: trig functions expect degrees (sin(30)=0.5). Inverse trig returns degrees. Use ^ for power.
    </div>
  </div>
</div>

<script>
/* ======= Reliable evaluation context and helpers ======= */
const ctx = {
  sin: x => Math.sin(Number(x) * Math.PI / 180),
  cos: x => Math.cos(Number(x) * Math.PI / 180),
  tan: x => Math.tan(Number(x) * Math.PI / 180),
  asin: x => Math.asin(Number(x)) * 180 / Math.PI,
  acos: x => Math.acos(Number(x)) * 180 / Math.PI,
  atan: x => Math.atan(Number(x)) * 180 / Math.PI,
  sqrt: x => Math.sqrt(Number(x)),
  log: x => (Math.log10 ? Math.log10(Number(x)) : Math.log(Number(x))/Math.LN10),
  ln: x => Math.log(Number(x)),
  exp: x => Math.exp(Number(x)),
  abs: x => Math.abs(Number(x)),
  fact: function(n){
    n = Math.floor(Number(n));
    if (isNaN(n) || n < 0) return NaN;
    if (n === 0 || n === 1) return 1;
    let f = 1;
    for (let i=2;i<=n;i++) f *= i;
    return f;
  },
  PI: Math.PI,
  E: Math.E
};

function safeEval(expr){
  expr = String(expr).replace(/\^/g, '**');
  expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
  expr = expr.replace(/\bPI\b/g, ctx.PI).replace(/\bE\b/g, ctx.E);

  const argNames = Object.keys(ctx);
  const argValues = argNames.map(k => ctx[k]);
  const func = Function(...argNames, '"use strict"; return (' + expr + ');');
  return func(...argValues);
}

/* ======= Modal controls and button wiring ======= */
const modal = document.getElementById('sciCalcModal');
const openBtn = document.getElementById('openSciCalc');
const closeBtn = document.getElementById('closeSciCalc');
const display = document.getElementById('sciDisplay');

/*function focusDisplay() {
  setTimeout(() => display.focus(), 50);
}*/

function focusDisplay() {
  display.focus();
  const len = display.value.length;
  display.setSelectionRange(len, len); // Moves caret to end
}

openBtn && (openBtn.onclick = () => { modal.style.display = 'flex'; display.value = ''; focusDisplay(); });
closeBtn.onclick = () => modal.style.display = 'none';
modal.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });

document.querySelectorAll('.sc-btn').forEach(b=>{
  b.style.padding = '12px';
  b.style.fontSize = '1.05rem';
  b.style.borderRadius = '8px';
  b.style.border = 'none';
  b.style.cursor = 'pointer';
  b.style.background = '#1976d2';
  b.style.color = '#fff';
});
document.querySelectorAll('.sc-op').forEach(b=> b.style.background = '#1565c0');
document.querySelectorAll('.sc-num').forEach(b=> b.style.background = '#2196f3');
document.querySelectorAll('.sc-fn').forEach(b=> b.style.background = '#0288d1');
document.querySelectorAll('.sc-const').forEach(b=> b.style.background = '#1976d2');

/* Buttons */
document.querySelectorAll('.sc-num, .sc-op').forEach(btn=>{
  btn.addEventListener('click', ()=> { display.value += btn.textContent; focusDisplay(); });
});
document.querySelectorAll('.sc-tok').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const t = btn.getAttribute('data-t');
    if (t) display.value += t;
    focusDisplay();
  });
});
document.querySelectorAll('.sc-fn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const t = btn.getAttribute('data-t');
    if (t) display.value += t;
    focusDisplay();
  });
});
document.getElementById('sciPI').addEventListener('click', ()=> { display.value += 'PI'; focusDisplay(); });
document.getElementById('sciE').addEventListener('click', ()=> { display.value += 'E'; focusDisplay(); });
document.getElementById('sciClear').addEventListener('click', ()=> { display.value = ''; focusDisplay(); });
//document.getElementById('sciDel').addEventListener('click', ()=> { display.value = display.value.slice(0, -1); focusDisplay(); });
document.getElementById('sciBack').addEventListener('click', ()=> { display.value = display.value.slice(0, -1); focusDisplay(); });

// --- Delete (right delete)
document.getElementById('sciDel').addEventListener('click', () => {
  const start = display.selectionStart;
  const end = display.selectionEnd;
  if (start === end && start < display.value.length) {
    display.value = display.value.slice(0, start) + display.value.slice(start + 1);
    display.setSelectionRange(start, start);
  } else {
    display.value = display.value.slice(0, start) + display.value.slice(end);
    display.setSelectionRange(start, start);
  }
  display.focus();
});


document.getElementById('sciEqual').addEventListener('click', ()=> {
  const expr = display.value.trim();
  if (!expr) return;
  try {
    const out = safeEval(expr);
    if (typeof out === 'number') {
      if (!isFinite(out)) display.value = String(out);
      else {
        display.value = (Math.abs(Math.round(out) - out) < 1e-12)
          ? String(Math.round(out))
          : Number(out.toPrecision(12)).toString();
      }
    } else {
      display.value = String(out);
    }
  } catch (err) {
    display.value = 'Error';
  }
  focusDisplay();
});

</script>

</body>
</html>
